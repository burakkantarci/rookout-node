{"version":3,"sources":["../../src/singleton.js"],"names":["uuid4","require","config","Output","default","Singleton","constructor","id","replace","output","servicesStarted","triggerServices","augManager","agentCom","monitorService","close","logger","info","stopServices","flush","callback","flushMessages","startServices","enableMonitor","SystemDataCollector","start","TriggerServices","AugManager","stop","triggerSvc","notifyLambdaActive","context","notifyLambdaInactive","connect","token","host","port","proxy","tags","labels","debug","AgentCom","commandHandler","CommandHandler","setAgentCom","connectToAgent","AgentComConfiguration","TIMEOUT","singleton"],"mappings":"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","sourcesContent":["\"use strict\";\r\n\r\nimport {SystemDataCollector} from \"./services/SystemDataCollector\";\r\n\r\nconst uuid4 = require(\"uuid/v4\");\r\n\r\nimport CommandHandler from \"./com_ws/CommandHandler\";\r\n\r\nconst config = require('./config');\r\n\r\nimport {logger} from \"./logger\";\r\n\r\nconst Output = require(\"./com_ws/OutputWs\").default;\r\nimport TriggerServices from \"./TriggerServices\";\r\nimport AugManager from \"./augs/AugManager\";\r\n\r\nclass Singleton {\r\n    constructor() {\r\n        this.id = uuid4().replace(/\\-/g, \"\");\r\n        this.output = new Output(this.id);\r\n\r\n        this.servicesStarted = false;\r\n        this.triggerServices = null;\r\n        this.augManager = null;\r\n\r\n        this.agentCom = null;\r\n        this.monitorService = null;\r\n    }\r\n\r\n    async close() {\r\n        logger.info(\"Shutting down\");\r\n\r\n        const agentCom = this.agentCom;\r\n        this.agentCom = null;\r\n        if (null !== agentCom) {\r\n            await agentCom.close()\r\n        }\r\n\r\n        await this.stopServices();\r\n    }\r\n\r\n    flush(callback) {\r\n        this.output.flushMessages(callback);\r\n    }\r\n\r\n    startServices(enableMonitor=false) {\r\n        if (this.servicesStarted) {\r\n            return;\r\n        }\r\n\r\n        if (enableMonitor) {\r\n            this.monitorService = new SystemDataCollector();\r\n            this.monitorService.start();\r\n        }\r\n\r\n        this.triggerServices = new TriggerServices();\r\n        this.augManager = new AugManager(this.triggerServices, this.output);\r\n        this.servicesStarted = true;\r\n    }\r\n\r\n    async stopServices() {\r\n        if (!this.servicesStarted) {\r\n            return;\r\n        }\r\n\r\n        if (this.monitorService) {\r\n            this.monitorService.stop();\r\n        }\r\n\r\n        this.augManager = null;\r\n\r\n        const triggerSvc = this.triggerServices;\r\n        this.triggerServices = null;\r\n        await triggerSvc.close();\r\n\r\n        this.servicesStarted = false;\r\n    }\r\n\r\n    notifyLambdaActive(context) {\r\n        if (null !== this.agentCom) {\r\n            this.agentCom.notifyLambdaActive(context);\r\n        }\r\n    }\r\n\r\n    notifyLambdaInactive() {\r\n        if (null !== this.agentCom) {\r\n            this.agentCom.notifyLambdaInactive();\r\n        }\r\n    }\r\n\r\n    connect(token, host, port, proxy, tags, labels, debug, enableMonitor=false) {\r\n        this.startServices(enableMonitor);\r\n\r\n        logger.debug(\"Initiating AgentCom-\\t%s:%d\", host, port);\r\n        const AgentCom = require(\"./com_ws/AgentComWs\").default;\r\n        this.agentCom = new AgentCom(this.id, host, port, proxy, token, labels, tags, debug);\r\n        this.commandHandler = new CommandHandler(this.agentCom, this.augManager);\r\n        this.output.setAgentCom(this.agentCom);\r\n\r\n        return this.agentCom.connectToAgent(config.AgentComConfiguration.TIMEOUT * 1000);\r\n    }\r\n}\r\n\r\nexport let singleton = new Singleton();\r\n"],"file":"singleton.js"}