{"version":3,"sources":["../../../src/augs/Aug.js"],"names":["rook","require","uuid4","process","__rookout_backchannel","DebuggerBackchannel","ContainerNamespace","ObjectNamespace","JSObjectNamespace","Aug","constructor","augId","location","action","condition","output","triggerServices","maxAugTime","limits","status","enabled","_warningCache","Map","_logCache","_scopeSample","undefined","_removedExternally","length","rateLimiter","RateLimiter","addAug","e","message","logger","exception","setError","RookError","removeAugTemporarilyAndReapplyAfterDuration","duration","info","removeAugTemporarily","setTimeout","reapplyAugAfterTemporaryRemoval","unref","execute","frame","stack","startTime","Date","now","checkRateLimit","record","namespace","JSUtilsNamespace","NoopNamespace","ProcessStateNamespace","conditionEvaluateResult","evaluate","msgId","replace","UserWarnings","RookRuleMaxExecutionTimeReached","rookError","shouldSilenceLog","setActive","sendRuleStatus","setPending","setRemoved","error","setUnknown","sendWarning","warn","logCache","has","size","set","allow","RookRuleRateLimited"],"mappings":"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","sourcesContent":["\"use strict\";\r\n\r\nimport RookError from \"../processor/RookError\";\r\nimport {RookRuleMaxExecutionTimeReached, RookRuleRateLimited} from \"../exceptions\";\r\n\r\nimport {logger} from \"../logger\";\r\nimport UserWarnings from \"../UserWarnings\";\r\n\r\nconst rook = require('../index');\r\nimport {singleton} from \"../singleton\";\r\nimport ContainerNamespace from \"../processor/namespaces/ContainerNamespace\"\r\nimport JSUtilsNamespace from \"../processor/namespaces/JSUtilsNamespace\"\r\nimport RateLimiter from \"./RateLimiter\";\r\nimport DebuggerBackchannel from \"../services/DebuggerBackchannel\";\r\nimport JSObjectNamespace from \"../processor/namespaces/JSObjectNamespace\";\r\nimport NoopNamespace from \"../processor/namespaces/NoopNamespace\";\r\nimport ProcessStateNamespace from \"../processor/namespaces/ProcessStateNamespace\";\r\nconst uuid4 = require(\"uuid/v4\");\r\n\r\nprocess.__rookout_backchannel = new DebuggerBackchannel();\r\nprocess.__rookout_backchannel.ContainerNamespace = ContainerNamespace;\r\nprocess.__rookout_backchannel.ObjectNamespace = JSObjectNamespace;\r\n\r\nexport default class Aug {\r\n    constructor(augId, location, action, condition, output, triggerServices, maxAugTime, limits) {\r\n        this.triggerServices = triggerServices;\r\n        this.augId = augId;\r\n        this.location = location;\r\n        this.action = action;\r\n        this.output = output;\r\n        this.status = null;\r\n        this.maxAugTime = maxAugTime;\r\n        this.enabled = true;\r\n        this.condition = condition;\r\n        this._warningCache = new Map();\r\n        this._logCache = new Map();\r\n        this._scopeSample = undefined;\r\n        this._removedExternally = false;\r\n\r\n        if (limits !== undefined && limits.length > 0) {\r\n            this.rateLimiter = new RateLimiter(limits[0], limits[1]);\r\n        } else {\r\n            this.rateLimiter = new RateLimiter();\r\n        }\r\n    }\r\n\r\n    addAug() {\r\n        try {\r\n            this.location.addAug(this.triggerServices, this);\r\n        } catch (e) {\r\n            const message = \"Exception when adding aug\";\r\n            logger.exception(message, e);\r\n            this.setError(new RookError(e, message));\r\n        }\r\n    }\r\n\r\n    removeAugTemporarilyAndReapplyAfterDuration(duration) {\r\n        logger.info(\"Temporarily removing aug %s for %sms\", this.augId, duration);\r\n        try {\r\n            this.triggerServices.removeAugTemporarily(this.augId);\r\n            setTimeout(() => {\r\n                if (!this._removedExternally) {\r\n                    logger.info(\"Re-adding aug %s after %sms\", this.augId, duration);\r\n                    this.triggerServices.reapplyAugAfterTemporaryRemoval(this);\r\n                }\r\n            }, duration).unref();\r\n        } catch (e) {\r\n            const message = \"Exception when removing aug temporarily\";\r\n            logger.exception(message, e);\r\n            this.setError(new RookError(e, message));\r\n        }\r\n    }\r\n\r\n    execute(frame, stack) {\r\n        if (!this.enabled) {\r\n            return;\r\n        }\r\n\r\n        try {\r\n            let startTime = Date.now();\r\n            if (!this.checkRateLimit()) {\r\n                let duration = Date.now() - startTime;\r\n\r\n                this.rateLimiter.record(startTime, duration);\r\n                return;\r\n            }\r\n\r\n            startTime = Date.now();\r\n\r\n\r\n            let namespace = new ContainerNamespace({\r\n                'frame': frame,\r\n                'stack': stack,\r\n                'store': new ContainerNamespace({}),\r\n                'temp': new ContainerNamespace({}),\r\n                'utils': new JSUtilsNamespace({}),\r\n                'trace': new NoopNamespace(),\r\n                'state': new ProcessStateNamespace()\r\n            });\r\n\r\n            if (this.condition !== undefined) {\r\n                const conditionEvaluateResult = this.condition.evaluate(namespace);\r\n                let duration = Date.now() - startTime;\r\n                this.rateLimiter.record(startTime, duration);\r\n                if (!conditionEvaluateResult) {\r\n                    return;\r\n                }\r\n                startTime = Date.now();\r\n            }\r\n\r\n            const msgId = uuid4().replace(/\\-/g, \"\");\r\n            logger.info(\"Executing aug-\\t%s (msg ID %s)\", this.augId, msgId)\r\n            this.action.execute(this.augId, msgId, namespace, this.output, new UserWarnings(this));\r\n\r\n            let duration = Date.now() - startTime;\r\n\r\n            this.rateLimiter.record(startTime, duration);\r\n\r\n            if (this.maxAugTime && this.maxAugTime > 0 && duration > this.maxAugTime) {\r\n                this.enabled = false;\r\n                throw new RookRuleMaxExecutionTimeReached();\r\n            }\r\n        } catch (e) {\r\n            const message = \"Exception while processing Aug\";\r\n            let rookError = new RookError(e, message);\r\n\r\n            if (!this.shouldSilenceLog(rookError, this._logCache)) {\r\n                logger.exception(message, e);\r\n            }\r\n\r\n            this.setError(rookError);\r\n        }\r\n    }\r\n\r\n    setActive() {\r\n        this.sendRuleStatus(\"Active\");\r\n    }\r\n\r\n    setPending() {\r\n        this.sendRuleStatus(\"Pending\");\r\n    }\r\n\r\n    setRemoved() {\r\n        this.sendRuleStatus(\"Deleted\");\r\n        this._removedExternally = true;\r\n    }\r\n\r\n    setError(error) {\r\n        this.sendRuleStatus(\"Error\", error);\r\n    }\r\n\r\n    setUnknown(error) {\r\n        this.sendRuleStatus(\"Unknown\", error);\r\n    }\r\n\r\n    sendWarning(error) {\r\n        if (this.shouldSilenceLog(error, this._warningCache)) {\r\n            return;\r\n        }\r\n\r\n        logger.warn(error.message);\r\n\r\n        this.output.sendWarning(this.augId, error);\r\n    }\r\n\r\n    sendRuleStatus(status, error=null) {\r\n        if (this.status === status) {\r\n            return;\r\n        }\r\n\r\n        logger.info(\"Updating rule status for %s to %s\", this.augId, status);\r\n\r\n        this.status = status;\r\n        this.output.sendRuleStatus(this.augId, status, error);\r\n    }\r\n\r\n    shouldSilenceLog(error, logCache) {\r\n        if (logCache.has(error.message) || logCache.size >= 10) {\r\n            return true;\r\n        }\r\n\r\n        logCache.set(error.message, true);\r\n\r\n        return false;\r\n    }\r\n\r\n    checkRateLimit() {\r\n        try {\r\n            if (!this.rateLimiter.allow(Date.now())) {\r\n                this.sendWarning(new RookError(new RookRuleRateLimited()));\r\n                this.removeAugTemporarilyAndReapplyAfterDuration(1000);\r\n                return false;\r\n            } else {\r\n                return true;\r\n            }\r\n        } catch (e) {\r\n            return false;\r\n        }\r\n    }\r\n}\r\n"],"file":"Aug.js"}