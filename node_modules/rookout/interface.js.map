{"version":3,"sources":["../../src/interface.js"],"names":["util","require","RookMissingToken","RookUnsupportedNodeVersion","RookInvalidToken","RookInvalidOptions","RookOldServers","RookUnsupportedRuntime","trueValues","Rook","constructor","savedOptions","startSync","timeout","options","deasync","e","message","throw_errors","Error","console","error","ready","connected","start","then","catch","startTime","Date","now","loopWhile","undefined","log","Object","keys","length","self","startAttempted","Promise","resolve","reject","singleton","debug","indexOf","process","env","ROOKOUT_DEBUG","log_to_stderr","ROOKOUT_LOG_TO_STDERR","log_file","ROOKOUT_LOG_FILE","LAMBDA_TASK_ROOT","lambda_safe_start","RookIllegalLambdaStart","log_level","ROOKOUT_LOG_LEVEL","checkVersionSupported","config","_verifyBoolean","LoggingConfiguration","LOG_TO_STDERR","_verifyString","LOG_LEVEL","FILE_NAME","tags","rawTags","ROOKOUT_ROOK_TAGS","tag","replace","split","push","StringUtils","trim","Array","isArray","labels","ROOKOUT_LABELS","label","kv","key","value","Map","originalLabels","_verifyLabel","DEBUG","git_commit","GitConfiguration","GIT_COMMIT","git_origin","GIT_ORIGIN","enableMonitor","enable_monitor","ROOKOUT_ENABLE_MONITOR","MonitorConfiguration","ENABLED","host","ROOKOUT_CONTROLLER_HOST","ROOKOUT_AGENT_HOST","port","ROOKOUT_CONTROLLER_PORT","ROOKOUT_AGENT_PORT","proxy","ROOKOUT_PROXY","token","ROOKOUT_TOKEN","logger","format","VersionConfiguration","VERSION","COMMIT","versions","node","_verifyToken","_print_options","substring","ControllerAddress","HOST","PORT","connect","stack","stop","close","flush","callback","notifyLambdaActive","context","notifyLambdaInactive","config_string","object","errorString","String","test","startsWith","RookInvalidLabel","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nconst util = require('util');\nimport {StringUtils} from \"./utils\";\nimport { RookIllegalLambdaStart, RookInvalidLabel } from './exceptions'\n\nconst {RookMissingToken,\n    RookUnsupportedNodeVersion,\n    RookInvalidToken,\n    RookInvalidOptions,\n    RookOldServers,\n    RookUnsupportedRuntime} = require('./exceptions');\n\nconst trueValues = ['y', 'Y', 'yes',  'Yes',  'YES', 'true', 'True', 'TRUE', '1', true];\n\nclass Rook {\n    constructor() {\n        this.savedOptions = null;\n    }\n\n    startSync(timeout = 5000, options = {}) {\n        if (typeof timeout === 'object') {\n            options = timeout;\n            timeout = 5000;\n        }\n\n        let deasync;\n\n        try {\n            deasync = require('deasync');\n        } catch (e) {\n            const message = \"[Rookout] To use startSync, install deasync (npm install deasync)\";\n            if (options.throw_errors) {\n                throw new Error(e);\n            } else {\n                console.error(message);\n            }\n            return;\n        }\n\n        if (deasync) {\n            let ready = false;\n            let connected = false;\n            let error;\n\n            this.start(options).then(() => {\n                ready = true;\n                connected = true;\n            }).catch((e) => {\n                ready = true;\n                connected = false;\n                error = e\n            });\n\n            let startTime = Date.now();\n\n            deasync.loopWhile(() => {\n                if (timeout === undefined) {\n                    return ready === false;\n                } else {\n                    return ready === false && Date.now() <= startTime + timeout;\n                }\n            });\n\n            if (!connected) {\n                if (undefined === error) {\n                    error = new Error(\"[Rookout] Connection to Controller timed out\");\n                }\n\n                if (options.throw_errors) {\n                    throw error;\n                } else {\n                    console.log(error.message);\n                }\n            }\n        } else {\n            this.start(options);\n        }\n    }\n\n    start(options = {}) {\n        if (Object.keys(options).length === 0 && this.savedOptions !== null) {\n            options = this.savedOptions;\n        }\n\n        let self = this;\n        this.startAttempted = true;\n\n        return new Promise((resolve, reject) => {\n            try {\n                if (self.singleton) resolve();\n\n                self.debug = false;\n\n                if (options.debug === undefined) {\n                    self.debug = trueValues.indexOf(process.env.ROOKOUT_DEBUG) !== -1;\n                } else {\n                    self.debug = options.debug;\n                }\n\n                if (options.log_to_stderr === undefined && process.env.ROOKOUT_LOG_TO_STDERR !== undefined) {\n                    options.log_to_stderr = trueValues.indexOf(process.env.ROOKOUT_LOG_TO_STDERR) !== -1;\n                }\n\n                if (options.log_file === undefined && process.env.ROOKOUT_LOG_FILE !== undefined) {\n                    options.log_file = process.env.ROOKOUT_LOG_FILE;\n                }\n\n                if (process.env.LAMBDA_TASK_ROOT) {\n                    options.log_file = \"\";\n                    if (options.lambda_safe_start !== true) {\n                        throw new RookIllegalLambdaStart();\n                    }\n                }\n\n                options.log_level = options.log_level || process.env.ROOKOUT_LOG_LEVEL;\n\n                self.throw_errors = false;\n\n                if (options.throw_errors !== undefined) {\n                    self.throw_errors = options.throw_errors;\n                }\n\n                Rook.checkVersionSupported();\n\n                const config = require('./config');\n\n                Rook._verifyBoolean(self.throw_errors, 'Rook throw errors should be a boolean');\n\n                if (options.log_to_stderr !== undefined) {\n                    Rook._verifyBoolean(options.log_to_stderr, 'Rook log to stderr should be a boolean');\n                    config.LoggingConfiguration.LOG_TO_STDERR = options.log_to_stderr;\n                }\n\n                if (options.log_level !== undefined) {\n                    Rook._verifyString(options.log_level, 'Rook log level should be a String');\n                    config.LoggingConfiguration.LOG_LEVEL = options.log_level;\n                }\n\n                if (options.log_file !== undefined) {\n                    Rook._verifyString(options.log_file, 'Rook log file should be a String');\n                    config.LoggingConfiguration.FILE_NAME = options.log_file;\n                }\n\n                if (options.tags === undefined) {\n                    let rawTags = process.env.ROOKOUT_ROOK_TAGS;\n\n                    if (rawTags !== undefined) {\n                        options.tags = [];\n\n                        for (let tag of rawTags.replace(/['\"]/g, '').split(';')) {\n                            options.tags.push(StringUtils.trim(tag));\n                        }\n                    }\n                } else {\n                    if (Array.isArray(options.tags)) {\n                        for (let tag of options.tags) {\n                            Rook._verifyString(tag, 'Rook tags should be array of strings');\n                        }\n                    } else {\n                        throw new RookInvalidOptions('Rook tags should be array of strings');\n                    }\n                }\n\n                if (options.labels === undefined) {\n                    let labels = process.env.ROOKOUT_LABELS;\n                    if (labels !== undefined) {\n                        options.labels = {};\n\n                        for (let label of labels.replace(/['\"]/g, '').split(',')) {\n                            let kv = label.split(':');\n                            if (kv.length === 2) {\n                                let key = kv[0];\n                                let value = kv[1];\n\n                                if (key && value) {\n                                    options.labels[key] = value;\n                                }\n                            }\n                        }\n                    }\n                } else {\n                    // Normalize the map to native dictionary\n                    if (options.labels instanceof Map) {\n                        let originalLabels = options.labels;\n                        options.labels = {}\n                        for (let [key, value] of originalLabels) {\n                            options.labels[key] = value;\n                        }\n                    }\n\n                    for (let label of Object.keys(options.labels)) {\n                        Rook._verifyString(label);\n                        Rook._verifyString(options.labels[label], 'Rook label should be a map of strings');\n                        Rook._verifyLabel(label);\n                    }\n                }\n\n                Rook._verifyBoolean(self.debug, 'Rook debug flag should be a boolean');\n\n                if (self.debug) {\n                    config.LoggingConfiguration.LOG_LEVEL = 'DEBUG';\n                    config.LoggingConfiguration.LOG_TO_STDERR = true;\n                    config.LoggingConfiguration.DEBUG = true;\n                }\n\n                if (options.git_commit !== undefined) {\n                    Rook._verifyString(options.git_commit, 'Git commit should be a String');\n                    config.GitConfiguration.GIT_COMMIT = options.git_commit;\n                }\n\n                if (options.git_origin !== undefined) {\n                    Rook._verifyString(options.git_origin, 'Git origin should be a String');\n                    config.GitConfiguration.GIT_ORIGIN = options.git_origin;\n                }\n\n                let enableMonitor = options.enable_monitor || process.env.ROOKOUT_ENABLE_MONITOR\n                    || config.MonitorConfiguration.ENABLED;\n\n                let host = options.host || process.env.ROOKOUT_CONTROLLER_HOST || process.env.ROOKOUT_AGENT_HOST;\n                let port = options.port || process.env.ROOKOUT_CONTROLLER_PORT || process.env.ROOKOUT_AGENT_PORT;\n                let proxy = options.proxy || process.env.ROOKOUT_PROXY;\n                let token = options.token || process.env.ROOKOUT_TOKEN;\n\n                if (proxy !== undefined) {\n                    Rook._verifyString(proxy, 'proxy should be a string');\n                }\n\n                const {logger} = require('./logger');\n                logger.debug(util.format('Rookout SDK [%s]:[%s] for NodeJS [%s]', config.VersionConfiguration.VERSION,\n                    config.VersionConfiguration.COMMIT, process.versions.node));\n\n                if (host === undefined && token === undefined) {\n                    throw new RookMissingToken();\n                } else {\n                    if (token !== undefined) {\n                        Rook._verifyToken(token);\n                    }\n                }\n\n                if (this.debug) {\n                    Rook._print_options({\n                        token: (token !== undefined) ? token.substring(0, 5) + \".....\" : undefined,\n                        host: host,\n                        port: port,\n                        proxy: proxy,\n                        throw_errors: self.throw_errors,\n                        log_level: options.log_level,\n                        log_to_stderr: options.log_to_stderr,\n                        log_file: options.log_file,\n                        git_commit: options.git_commit,\n                        git_origin: options.git_origin,\n                        tags: options.tags,\n                        labels: options.labels\n                    });\n                }\n\n                host = host || config.ControllerAddress.HOST;\n                Rook._verifyString(host, 'Rook host should be String');\n\n                if ((host === \"staging.cloud.agent.rookout.com\") || (host === \"cloud.agent.rookout.com\")) {\n                    throw new RookOldServers();\n                }\n\n                port = port || config.ControllerAddress.PORT;\n                if (!((typeof port === 'number') || (typeof port === 'string'))) {\n                    throw new RookInvalidOptions('Rook port should be a Number or a String');\n                }\n\n                this.savedOptions = options;\n                self.singleton = require('./singleton').singleton;\n                self.singleton.connect(token, host, port, proxy, options.tags, options.labels, this.debug, enableMonitor).catch((e) => {\n                    if (self.throw_errors) {\n                        reject(e);\n                    } else {\n                        if (e instanceof RookInvalidToken || e instanceof RookOldServers || e instanceof RookIllegalLambdaStart) {\n                            console.log('[Rookout] ', e.message);\n                        } else {\n                            console.error('[Rookout] Failed to connect to the controller - will continue attempting in the background: ', e.message);\n                        }\n\n                        if (self.debug) {\n                            console.error(e.stack || e);\n                        }\n\n                        resolve(self);\n                    }\n                }).then(() => resolve(self));\n            } catch (e) {\n                if (self.throw_errors) {\n                    reject(e);\n                } else {\n                    console.error('[Rookout] Failed to start Rookout: ', e.message);\n\n                    if (self.debug) {\n                        console.error(e.stack || e);\n                    }\n\n                    resolve(self);\n                }\n            }\n        });\n    }\n\n    async stop() {\n        if (!this.singleton) return;\n\n        try {\n            const singleton = this.singleton;\n            this.singleton = undefined;\n            await singleton.close();\n        } catch (e) {\n            if (this.throw_errors) {\n                throw e;\n            }\n\n            if (this.debug) {\n                console.error(e.stack || e);\n            }\n        }\n    }\n\n    flush(callback) {\n        if (!this.singleton) {\n            if (callback !== undefined) {\n                callback();\n            }\n            return;\n        }\n\n        try {\n            this.singleton.flush(callback);\n        } catch (e) {\n            if (this.throw_errors) {\n                throw e;\n            }\n\n            if (this.debug) {\n                console.error(e.stack || e);\n            }\n        }\n    }\n\n    notifyLambdaActive(context) {\n        this.singleton.notifyLambdaActive(context);\n    }\n\n    notifyLambdaInactive() {\n        this.singleton.notifyLambdaInactive();\n    }\n\n    static _print_options(options = {}) {\n        try {\n            let config_string = \"\";\n            for (let key in options) {\n                if (options[key] !== undefined) {\n                    config_string = config_string + key + \": \" + options[key] + \", \";\n                }\n            }\n            console.log(\"RookOptions: \" + config_string);\n        } catch (e) { }\n    }\n\n    static _verifyBoolean(object, errorString) {\n        if (!(typeof object === 'boolean')) {\n            throw new RookInvalidOptions(errorString);\n        }\n    };\n\n    static _verifyString(object, errorString) {\n        if (!(typeof object === 'string' || object instanceof String)) {\n            throw new RookInvalidOptions(errorString);\n        }\n    };\n\n    static _verifyToken(object) {\n        Rook._verifyString(object, 'Rookout token should be a String');\n\n        if (object.length !== 64) {\n            throw new RookInvalidOptions('Rookout token should be 64 characters');\n        }\n\n        if (/^[0-9a-zA-Z]+$/.test(object) === false) {\n            throw new RookInvalidOptions('Rookout token must consist of only hexadecimal characters')\n        }\n    };\n\n    static _verifyLabel(label) {\n        if (label.startsWith(\"$\")) {\n            throw new RookInvalidLabel(label);\n        }\n    }\n\n    static checkVersionSupported() {\n        if (!process || !process.versions || !process.versions.node) {\n            throw new RookUnsupportedRuntime();\n        }\n\n        if (process.versions.node.startsWith('8.9.1')) {\n            throw new RookUnsupportedNodeVersion(process.versions.node);\n        }\n    }\n}\n\nmodule.exports = Rook;\n"],"file":"interface.js"}